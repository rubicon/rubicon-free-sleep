{"version":3,"file":"unixSocketServer.js","sources":["8sleep/unixSocketServer.ts"],"sourceRoot":"/","sourcesContent":["import { once } from 'events';\nimport { unlink } from 'fs/promises';\nimport { createServer, Server, Socket } from 'net';\nimport logger from '../logger.js';\n\nexport class UnixSocketServer {\n  private readonly pendingConnections: Socket[] = [];\n  private waiting: ((socket: Socket) => void) | undefined;\n\n  public constructor(private readonly server: Server) {\n    this.server.on('connection', (socket) => this.handleConnection(socket));\n  }\n\n  private handleConnection(socket: Socket) {\n    socket.on('error', (error) => logger.error({ error, message: 'Unix socket connection error' }));\n\n    if (this.waiting) {\n      const resolve = this.waiting;\n      this.waiting = undefined;\n      resolve(socket);\n      return;\n    }\n\n    while (this.pendingConnections.length > 0) {\n      const stale = this.pendingConnections.shift();\n      stale?.destroy();\n    }\n\n    this.pendingConnections.push(socket);\n  }\n\n  public async close() {\n    this.waiting = undefined;\n    this.pendingConnections.splice(0).forEach(socket => socket.destroy());\n    this.server.close();\n    await once(this.server, 'close');\n  }\n\n  public async waitForConnection(): Promise<Socket> {\n    if (this.pendingConnections.length > 0) {\n      const connection = this.pendingConnections.shift() as Socket;\n      return connection;\n    }\n\n    logger.debug('Waiting for future connection');\n    return new Promise<Socket>((resolve) => this.waiting = resolve);\n  }\n\n  public static async start(path: string) {\n    logger.debug('Creating socket connection...');\n    await UnixSocketServer.tryCleanup(path);\n    const unixSocketServer = createServer();\n    unixSocketServer.on('error', (error) => logger.error({ error, message: 'Unix socket server error' }));\n\n    await new Promise<void>((resolve) => unixSocketServer.listen(path, resolve));\n\n    const socket = new UnixSocketServer(unixSocketServer);\n    logger.debug('Created socket connection!');\n    return socket;\n  }\n\n  private static async tryCleanup(path: string) {\n    try {\n      await unlink(path);\n    } catch (err) {\n      if ((err as any)?.code === 'ENOENT') return;\n      throw err;\n    }\n  }\n}\n"],"names":[],"mappings":"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","debug_id":"b2d3bd81-ba65-5c58-8f9b-00cf2dafe827"}