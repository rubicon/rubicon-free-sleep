{"version":3,"file":"frankenServer.js","sources":["8sleep/frankenServer.ts"],"sourceRoot":"/","sourcesContent":["import { Socket } from 'net';\n\nimport { SequentialQueue } from './sequentialQueue.js';\nimport { MessageStream } from './messageStream.js';\nimport { FrankenCommand, frankenCommands } from './deviceApi.js';\n\nimport { UnixSocketServer } from './unixSocketServer.js';\nimport logger from '../logger.js';\nimport { DeviceStatus } from '../routes/deviceStatus/deviceStatusSchema.js';\nimport { loadDeviceStatus } from './loadDeviceStatus.js';\nimport config from '../config.js';\nimport { toPromise, wait } from './promises.js';\n\nexport class Franken {\n  private static readonly responseDelayMs = 10;\n\n  public constructor(\n    private readonly socket: Socket,\n    private readonly messageStream: MessageStream,\n    private readonly sequentialQueue: SequentialQueue,\n  ) {\n  }\n\n  static readonly separator = Buffer.from('\\n\\n');\n\n  public async sendMessage(message: string) {\n    logger.debug(`Sending message to sock | message: ${message}`);\n    const responseBytes = await this.sequentialQueue.exec(async () => {\n      const requestBytes = Buffer.concat([Buffer.from(message), Franken.separator]);\n      await this.write(requestBytes);\n      const resp = await this.messageStream.readMessage();\n\n      if (Franken.responseDelayMs > 0) {\n        await wait(10);\n      }\n      return resp;\n    });\n    const response = responseBytes.toString();\n    logger.debug(`Message sent successfully to sock | message: ${message}`);\n\n    return response;\n  }\n\n  private tryStripNewlines(arg: string) {\n    const containsNewline = arg.indexOf('\\n') >= 0;\n    if (!containsNewline) return arg;\n    return arg.replace(/\\n/gm, '');\n  }\n\n  public async callFunction(command: FrankenCommand, arg: string) {\n    logger.debug(`Calling function | command: ${command} | arg: ${arg}`);\n    const commandNumber = frankenCommands[command];\n    const cleanedArg = this.tryStripNewlines(arg);\n    logger.debug(`commandNumber: ${commandNumber}`);\n    logger.debug(`cleanedArg: ${cleanedArg}`);\n    await this.sendMessage(`${commandNumber}\\n${cleanedArg}`);\n  }\n\n  public async getDeviceStatus(getGestures=false): Promise<DeviceStatus> {\n    const command: FrankenCommand = 'DEVICE_STATUS';\n    const commandNumber = frankenCommands[command];\n    const response = await this.sendMessage(commandNumber);\n    return await loadDeviceStatus(response, getGestures);\n  }\n\n  public close() {\n    const socket = this.socket;\n    if (!socket.destroyed) socket.destroy();\n  }\n\n  public static fromSocket(socket: Socket) {\n    const messageStream = new MessageStream(socket, Franken.separator);\n    return new Franken(socket, messageStream, new SequentialQueue());\n  }\n\n  private async write(data: Buffer) {\n    // @ts-expect-error\n    await toPromise(cb => this.socket.write(data, cb));\n  }\n}\n\nclass FrankenServer {\n  public constructor(private readonly server: UnixSocketServer) {\n  }\n\n  public async close() {\n    logger.debug('Closing FrankenServer socket...');\n    await this.server.close();\n  }\n\n  public async waitForFranken(): Promise<Franken> {\n    const socket = await this.server.waitForConnection();\n    logger.debug('FrankenServer connected');\n    return Franken.fromSocket(socket);\n  }\n\n  public static async start(path: string) {\n    logger.debug(`Creating franken server on socket: ${config.dacSockPath}`);\n    const unixSocketServer = await UnixSocketServer.start(path);\n    return new FrankenServer(unixSocketServer);\n  }\n}\n\nlet frankenServer: FrankenServer | undefined;\nlet franken: Franken | undefined;\nlet connectPromise: Promise<Franken> | undefined;\n\nexport async function connectFranken(): Promise<Franken> {\n  if (franken) return franken;\n  if (connectPromise) return connectPromise;\n\n  connectPromise = (async () => {\n    if (!frankenServer) {\n      frankenServer = await FrankenServer.start(config.dacSockPath);\n      logger.debug('FrankenServer started');\n    }\n\n    logger.debug('Waiting for Franken hardware connection...');\n    franken = await frankenServer.waitForFranken();\n    logger.info('Franken socket connected');\n    return franken;\n  })();\n\n  try {\n    return await connectPromise;\n  } finally {\n    connectPromise = undefined;\n  }\n}\n\nexport async function disconnectFranken() {\n  connectPromise = undefined;\n  franken?.close();\n  franken = undefined;\n  if (frankenServer) {\n    await frankenServer.close();\n    frankenServer = undefined;\n  }\n}\n"],"names":[],"mappings":"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","debug_id":"2851f4d6-1201-5522-89b7-8cbbdb8a34b2"}