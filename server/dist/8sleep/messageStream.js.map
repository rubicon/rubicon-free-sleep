{"version":3,"file":"messageStream.js","sources":["8sleep/messageStream.ts"],"sourceRoot":"/","sourcesContent":["import { once } from 'events';\nimport binarySplit from 'binary-split';\nimport { Transform } from 'stream';\n\nexport class MessageStream {\n  private readonly splitter: Transform;\n  private readonly queue: Buffer[] = [];\n  private ended = false;\n  private error: unknown;\n\n  public constructor(\n    readable: NodeJS.ReadableStream,\n    separator = Buffer.from('\\n\\n')\n  ) {\n    this.splitter = binarySplit(separator);\n    this.splitter.on('data', (chunk: Buffer) => {\n      this.queue.push(chunk);\n    });\n    this.splitter.on('end', () => {\n      this.ended = true;\n    });\n    this.splitter.on('error', (err: unknown) => {\n      this.error = err;\n    });\n\n    readable.pipe(this.splitter);\n    readable.on('error', (error) => this.splitter.destroy(error));\n  }\n\n  public async readMessage(): Promise<Buffer> {\n    // eslint-disable-next-line no-constant-condition\n    while (true) {\n      if (this.queue.length > 0) {\n        return this.queue.shift() as Buffer;\n      }\n\n      if (this.error) {\n        const err = this.error;\n        this.error = undefined;\n        throw err;\n      }\n\n      if (this.ended) {\n        throw new Error('stream ended');\n      }\n\n      await once(this.splitter, 'data');\n    }\n  }\n}\n"],"names":[],"mappings":";;AAAA,OAAO,EAAE,IAAI,EAAE,MAAM,QAAQ,CAAC;AAC9B,OAAO,WAAW,MAAM,cAAc,CAAC;AAGvC,MAAM,OAAO,aAAa;IACP,QAAQ,CAAY;IACpB,KAAK,GAAa,EAAE,CAAC;IAC9B,KAAK,GAAG,KAAK,CAAC;IACd,KAAK,CAAU;IAEvB,YACE,QAA+B,EAC/B,SAAS,GAAG,MAAM,CAAC,IAAI,CAAC,MAAM,CAAC;QAE/B,IAAI,CAAC,QAAQ,GAAG,WAAW,CAAC,SAAS,CAAC,CAAC;QACvC,IAAI,CAAC,QAAQ,CAAC,EAAE,CAAC,MAAM,EAAE,CAAC,KAAa,EAAE,EAAE;YACzC,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;QACzB,CAAC,CAAC,CAAC;QACH,IAAI,CAAC,QAAQ,CAAC,EAAE,CAAC,KAAK,EAAE,GAAG,EAAE;YAC3B,IAAI,CAAC,KAAK,GAAG,IAAI,CAAC;QACpB,CAAC,CAAC,CAAC;QACH,IAAI,CAAC,QAAQ,CAAC,EAAE,CAAC,OAAO,EAAE,CAAC,GAAY,EAAE,EAAE;YACzC,IAAI,CAAC,KAAK,GAAG,GAAG,CAAC;QACnB,CAAC,CAAC,CAAC;QAEH,QAAQ,CAAC,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;QAC7B,QAAQ,CAAC,EAAE,CAAC,OAAO,EAAE,CAAC,KAAK,EAAE,EAAE,CAAC,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC,CAAC;IAChE,CAAC;IAEM,KAAK,CAAC,WAAW;QACtB,iDAAiD;QACjD,OAAO,IAAI,EAAE,CAAC;YACZ,IAAI,IAAI,CAAC,KAAK,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;gBAC1B,OAAO,IAAI,CAAC,KAAK,CAAC,KAAK,EAAY,CAAC;YACtC,CAAC;YAED,IAAI,IAAI,CAAC,KAAK,EAAE,CAAC;gBACf,MAAM,GAAG,GAAG,IAAI,CAAC,KAAK,CAAC;gBACvB,IAAI,CAAC,KAAK,GAAG,SAAS,CAAC;gBACvB,MAAM,GAAG,CAAC;YACZ,CAAC;YAED,IAAI,IAAI,CAAC,KAAK,EAAE,CAAC;gBACf,MAAM,IAAI,KAAK,CAAC,cAAc,CAAC,CAAC;YAClC,CAAC;YAED,MAAM,IAAI,CAAC,IAAI,CAAC,QAAQ,EAAE,MAAM,CAAC,CAAC;QACpC,CAAC;IACH,CAAC;CACF","debug_id":"e0e3226d-75bc-57dc-a2ce-b489355871f6"}