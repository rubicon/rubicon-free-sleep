{"version":3,"file":"frankenMonitor.js","sources":["8sleep/frankenMonitor.ts"],"sourceRoot":"/","sourcesContent":["import moment from 'moment-timezone';\nimport logger from '../logger.js';\nimport settingsDB from '../db/settings.js';\nimport { connectFranken } from './frankenServer.js';\nimport { wait } from './promises.js';\nimport { DeviceStatus, Version } from '../routes/deviceStatus/deviceStatusSchema.js';\nimport { Side } from '../db/schedulesSchema.js';\nimport { Gesture, GestureSchema } from '../db/settingsSchema.js';\nimport { updateDeviceStatus } from '../routes/deviceStatus/updateDeviceStatus.js';\nimport { DeepPartial } from 'ts-essentials';\nimport serverStatus from '../serverStatus.js';\n\n\n\nexport class FrankenMonitor {\n  private isRunning: boolean;\n  private deviceStatus?: DeviceStatus;\n\n  constructor() {\n    this.isRunning = false;\n    this.deviceStatus = undefined;\n  }\n\n  public async start() {\n    if (this.isRunning) {\n      logger.warn('FrankenMonitor is already running');\n      return;\n    }\n    this.isRunning = true;\n    this.frankenLoop().catch(error => {\n      logger.error(error);\n      serverStatus.status.frankenMonitor.status = 'failed';\n      serverStatus.status.frankenMonitor.message = String(error);\n      serverStatus.status.frankenMonitor.timestamp = moment.tz().format();\n    });\n  }\n\n  public stop() {\n    if (!this.isRunning) return;\n    logger.debug('Stopping FrankenMonitor loop');\n    this.isRunning = false;\n  }\n\n  private async processGesture(side: Side, gesture: Gesture) {\n    const behavior = settingsDB.data[side].taps[gesture];\n    if (behavior.type === 'temperature') {\n      const currentTemperatureTarget = this.deviceStatus![side].targetTemperatureF;\n      let newTemperatureTargetF;\n      const change = behavior.amount;\n      if (behavior.change === 'increment') {\n        newTemperatureTargetF = currentTemperatureTarget + change;\n      } else {\n        newTemperatureTargetF = currentTemperatureTarget + (-1 * change);\n      }\n      logger.debug(`Processing gesture temperature change for ${side}. ${currentTemperatureTarget} -> ${newTemperatureTargetF}`);\n      return await updateDeviceStatus({ [side]: { targetTemperatureF: newTemperatureTargetF } } as DeepPartial<DeviceStatus>);\n    } else if (behavior.type) {\n      // TODO: Add alarm handling\n      logger.warn('Skipping gesture...');\n    }\n  }\n\n  private processGesturesForSide(nextDeviceStatus: DeviceStatus, side: Side) {\n    for (const gesture of GestureSchema.options) {\n      if (nextDeviceStatus[side].taps![gesture] !== this.deviceStatus![side].taps![gesture]) {\n        this.processGesture(side, gesture);\n      }\n    }\n  }\n\n  private async processGestures(nextDeviceStatus: DeviceStatus) {\n    if (!this.deviceStatus) {\n      logger.warn('Missing current deviceStatus, exiting...');\n      return;\n    }\n\n    this.processGesturesForSide(nextDeviceStatus, 'left');\n    this.processGesturesForSide(nextDeviceStatus, 'right');\n  }\n\n\n  private async frankenLoop() {\n    const franken = await connectFranken();\n    this.deviceStatus = await franken.getDeviceStatus(false);\n    let hasGestures = this.deviceStatus.coverVersion !== Version.Pod3;\n    let waitTime = hasGestures ? 2_000 : 60_000;\n    if (hasGestures) {\n      this.deviceStatus = await franken.getDeviceStatus(false);\n      logger.debug(`Gestures supported for ${this.deviceStatus.coverVersion}`);\n    } else {\n      logger.debug(`Gestures not supported for ${this.deviceStatus.coverVersion}`);\n    }\n    // No point in querying device status every 3 seconds for checking the prime status...\n    while (this.isRunning) {\n      try {\n        while (this.isRunning) {\n          hasGestures = this.deviceStatus.coverVersion !== Version.Pod3;\n          waitTime = hasGestures ? 2_000 : 60_000;\n          await wait(waitTime);\n          if (!this.isRunning) break;\n          const franken = await connectFranken();\n          const nextDeviceStatus = await franken.getDeviceStatus(hasGestures);\n          await settingsDB.read();\n          if (hasGestures) {\n            this.processGestures(nextDeviceStatus);\n          }\n          this.deviceStatus = nextDeviceStatus;\n          serverStatus.status.frankenMonitor.status = 'healthy';\n          serverStatus.status.frankenMonitor.message = '';\n          serverStatus.status.frankenMonitor.timestamp = moment.tz().format();\n        }\n      } catch (error) {\n        serverStatus.status.frankenMonitor.status = 'failed';\n        serverStatus.status.frankenMonitor.message = String(error);\n        serverStatus.status.frankenMonitor.timestamp = moment.tz().format();\n        logger.error(error instanceof Error ? error.message : String(error), 'franken disconnected');\n        await wait(waitTime);\n      }\n    }\n    logger.debug('FrankenMonitor loop exited');\n  }\n}\n\n"],"names":[],"mappings":"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","debug_id":"9eb2647f-7871-5439-a4db-80e10068e73a"}