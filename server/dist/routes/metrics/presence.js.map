{"version":3,"file":"presence.js","sources":["routes/metrics/presence.ts"],"sourceRoot":"/","sourcesContent":["import express, { Request, Response, Router } from 'express';\nimport moment from 'moment-timezone';\nimport { z } from 'zod';\nimport logger from '../../logger.js';\nimport settingsDB from '../../db/settings.js';\n\nconst router: Router = express.Router();\n\nconst PresenceSideSchema = z.object({\n  present: z.boolean(),\n  lastUpdatedAt: z.string().optional(),\n});\n\nexport const PresenceDataSchema = z.object({\n  left: PresenceSideSchema.optional(),\n  right: PresenceSideSchema.optional(),\n});\n\ntype PresenceSide = z.infer<typeof PresenceSideSchema>;\n\ntype PresenceDataState = {\n  left: PresenceSide;\n  right: PresenceSide;\n};\n\n// In-memory storage for presence data\n// Default values are null until first update\nconst presenceData: PresenceDataState = {\n  left: {\n    present: false,\n    lastUpdatedAt: moment.tz(settingsDB.data.timeZone).format(),\n  },\n  right: {\n    present: false,\n    lastUpdatedAt: moment.tz(settingsDB.data.timeZone).format(),\n  },\n};\n\n/**\n * POST /presence\n * Update presence data for one or both sides\n */\nrouter.post('/presence', async (req: Request, res: Response) => {\n  try {\n    await settingsDB.read();\n    const { body } = req;\n    const validationResult = PresenceDataSchema.deepPartial().safeParse(body);\n    if (!validationResult.success) {\n      logger.error('Invalid device status update:', validationResult.error);\n      res.status(400).json({\n        error: 'Invalid request data',\n        details: validationResult?.error?.errors,\n      });\n      return;\n    }\n\n    // Check if at least one side is provided\n    if (!body.left && !body.right) {\n      return res.status(400).json({\n        error: 'At least one side (left or right) must be specified',\n        message: 'Please provide \"left\" and/or \"right\" with boolean values'\n      });\n    }\n\n    const currentTime = moment.tz(settingsDB.data.timeZone).format();\n\n    // Update left side if provided\n    if (body.left) {\n      presenceData.left.present = body.left.present;\n      presenceData.left.lastUpdatedAt = currentTime;\n    }\n\n    // Update right side if provided\n    if (body.right) {\n      presenceData.right.present = body.right.present;\n      presenceData.right.lastUpdatedAt = currentTime;\n    }\n\n    return res.status(200).json(presenceData);\n\n  } catch (error) {\n    console.error('Error updating presence:', error);\n    return res.status(500).json({\n      error: 'Internal server error',\n      message: (error as Error).message\n    });\n  }\n});\n\n/**\n * GET /presence\n */\nrouter.get('/presence', (req: Request, res: Response) => {\n  return res.status(200).json(presenceData);\n});\n\nexport default router;\n"],"names":[],"mappings":"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","debug_id":"b18ec96d-ee43-5c4f-b78e-940ae1fbafa1"}