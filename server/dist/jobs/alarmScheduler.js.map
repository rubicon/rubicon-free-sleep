{"version":3,"file":"alarmScheduler.js","sources":["jobs/alarmScheduler.ts"],"sourceRoot":"/","sourcesContent":["import schedule from 'node-schedule';\nimport cbor from 'cbor';\nimport moment from 'moment-timezone';\n\nimport logger from '../logger.js';\nimport memoryDB from '../db/memoryDB.js';\nimport serverStatus from '../serverStatus.js';\nimport schedulesDB from '../db/schedules.js';\nimport settingsDB from '../db/settings.js';\nimport { Alarm, DailySchedule, DayOfWeek, Side } from '../db/schedulesSchema.js';\nimport { executeFunction } from '../8sleep/deviceApi.js';\nimport { getDayIndexForSchedule, logJob } from './utils.js';\nimport { connectFranken } from '../8sleep/frankenServer.js';\nimport { Settings } from '../db/settingsSchema.js';\n\n\ntype ExecuteAlarmArgs = {\n  side: Side;\n  vibrationIntensity: Alarm['vibrationIntensity'];\n  duration: Alarm['duration'];\n  vibrationPattern: Alarm['vibrationPattern'];\n}\n\nconst executeAlarm = async ({ vibrationIntensity, duration, vibrationPattern, side }: ExecuteAlarmArgs) => {\n  try {\n    const min10Duration = Math.max(10, duration);\n    // Exit is side is in away mode\n    await settingsDB.read();\n    if (settingsDB.data[side].awayMode) {\n      if (settingsDB.data[side].awayMode) {\n        logger.debug('Not executing alarm, this side is in away mode!');\n        return;\n      }\n    }\n\n    // Exit if side is off\n    const franken = await connectFranken();\n    const resp = await franken.getDeviceStatus();\n    if (!resp[side].isOn) {\n      logger.debug('Not executing alarm, side is off!');\n      return;\n    }\n\n    const currentTime = moment.tz(settingsDB.data.timeZone);\n    const alarmTimeEpoch = currentTime.unix();\n\n    const alarmPayload = {\n      pl: vibrationIntensity,\n      du: min10Duration,\n      pi: vibrationPattern,\n      tt: alarmTimeEpoch,\n    };\n\n    const cborPayload = cbor.encode(alarmPayload);\n    const hexPayload = cborPayload.toString('hex');\n    const command = side === 'left' ? 'ALARM_LEFT' : 'ALARM_RIGHT';\n\n    logger.debug(`Executing alarm... ${JSON.stringify(alarmPayload)}`);\n    await executeFunction(command, hexPayload);\n    await memoryDB.read();\n    memoryDB.data[side].isAlarmVibrating = true;\n    await memoryDB.write();\n\n    setTimeout(\n      async () => {\n        logger.debug('');\n        await memoryDB.read();\n        memoryDB.data[side].isAlarmVibrating = false;\n        await memoryDB.write();\n      },\n      min10Duration * 1_000\n    );\n    serverStatus.status.alarmSchedule.status = 'healthy';\n    serverStatus.status.alarmSchedule.message = '';\n  } catch (error: unknown) {\n    serverStatus.status.alarmSchedule.status = 'failed';\n    const message = error instanceof Error ? error.message : String(error);\n    serverStatus.status.alarmSchedule.message = message;\n    logger.error(error);\n  }\n};\n\n\n/**\n * Next occurrence of HH:mm in tz (today or tomorrow depending on 'now').\n * If the HH:mm is already passed for 'now', schedule for tomorrow.\n */\nfunction nextOccurrenceHhMm(tz: string, hhmm: string) {\n  const now = moment.tz(tz);\n  const [h, m] = hhmm.split(':').map(Number);\n\n  const candidate = now.clone().hour(h).minute(m).second(0).millisecond(0);\n  if (candidate.isSameOrBefore(now)) {\n    candidate.add(1, 'day');\n  }\n\n  return candidate;\n}\n\nexport function scheduleAlarmOverride(settingsData: Settings, side: Side) {\n  const alarmOverride = settingsData[side]?.scheduleOverrides?.alarm;\n  if (!alarmOverride || alarmOverride.disabled) return null;\n  if (!alarmOverride.timeOverride || !alarmOverride.expiresAt) return null;\n\n  const now = moment.tz(settingsData.timeZone);\n  const expiresAt = moment.tz(alarmOverride.expiresAt, settingsData.timeZone);\n  if (!expiresAt.isAfter(now)) return null;\n  const next = nextOccurrenceHhMm(settingsData.timeZone, alarmOverride.timeOverride);\n  logger.debug(`Alarm override is set! Scheduling alarm for ${next.format()}`);\n\n  schedule.scheduleJob(`${side}-alarm-override-${alarmOverride.timeOverride}`, next.toDate(), async () => {\n    const dayKey = next.tz(settingsData.timeZone).format('dddd').toLowerCase() as DayOfWeek;\n    const daySchedule = schedulesDB.data?.[side]?.[dayKey];\n\n    const { vibrationIntensity, duration, vibrationPattern } = daySchedule?.alarm ?? {\n      vibrationIntensity: 100,\n      duration: 60,\n      vibrationPattern: 'rise',\n    };\n\n    await executeAlarm({\n      side,\n      vibrationIntensity,\n      duration,\n      vibrationPattern,\n    });\n  });\n}\n\n\nexport const scheduleAlarm = (settingsData: Settings, side: Side, day: DayOfWeek, dailySchedule: DailySchedule) => {\n  if (!dailySchedule.power.enabled) return;\n  if (!dailySchedule.alarm.enabled) return;\n  if (settingsData[side].awayMode) return;\n  if (settingsData.timeZone === null) return;\n\n  const alarmRule = new schedule.RecurrenceRule();\n\n  const dayIndex = getDayIndexForSchedule(day, dailySchedule.power.off);\n  alarmRule.dayOfWeek = dayIndex;\n\n  const { time } = dailySchedule.alarm;\n  const [alarmHour, alarmMinute] = time.split(':').map(Number);\n  alarmRule.hour = alarmHour;\n  alarmRule.minute = alarmMinute;\n  alarmRule.tz = settingsData.timeZone;\n\n  logJob('Scheduling alarm job', side, day, dayIndex, time);\n\n  schedule.scheduleJob(`${side}-${day}-${time}-alarm`, alarmRule, async () => {\n    try {\n      logJob('Executing alarm job', side, day, dayIndex, time);\n      await settingsDB.read();\n\n      if (settingsDB.data[side].scheduleOverrides.alarm.expiresAt) {\n        const expiresAt = moment(settingsDB.data[side].scheduleOverrides.alarm.expiresAt);\n        const now = moment();\n        if (expiresAt.isAfter(now)) {\n          logJob(`Detected alarm override! Skipping alarm! Override expires at: ${expiresAt.format()}`, side, day, dayIndex, time);\n          return;\n        }\n      }\n\n      await executeAlarm({\n        side,\n        vibrationIntensity: dailySchedule.alarm.vibrationIntensity,\n        duration: dailySchedule.alarm.duration,\n        vibrationPattern: dailySchedule.alarm.vibrationPattern,\n      });\n    } catch (error: unknown) {\n      serverStatus.status.alarmSchedule.status = 'failed';\n      const message = error instanceof Error ? error.message : String(error);\n      serverStatus.status.alarmSchedule.message = message;\n      logger.error(error);\n    }\n  });\n};\n\n"],"names":[],"mappings":"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","debug_id":"cbd4d246-c6e4-5213-9987-6f084bd5585f"}